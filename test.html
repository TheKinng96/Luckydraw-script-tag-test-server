<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Test Script Tag</title>

		<script type="text/javascript" src="http://localhost:5173/api/scriptTags/shop" async=""></script>
		<script>
			function base64ToBytes(b64) {
				const bin = atob(b64)
				const arr = new Uint8Array(bin.length)
				for (let i = 0; i < bin.length; i++) {
					arr[i] = bin.charCodeAt(i)
				}
				return arr
			}

			async function generateSignature() {
				const key = document.getElementById('key-input').value
				const payload = document.getElementById('payload-input').value
				const keyBytes = base64ToBytes(key)

				const subtleKey = await crypto.subtle.importKey(
					'raw',
					keyBytes,
					{ name: 'HMAC', hash: 'SHA-256' },
					false,
					['sign'],
				)

				const sigBuffer = await crypto.subtle.sign(
					'HMAC',
					subtleKey,
					new TextEncoder().encode(payload),
				)

				const signature = Array.from(new Uint8Array(sigBuffer))
					.map((b) => b.toString(16).padStart(2, '0'))
					.join('')

				document.getElementById('signature-output').textContent = signature
			}

			async function getHmacKey() {
				try {
					const response = await fetch('http://localhost:5173/api/hmac')
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`)
					}
					const data = await response.json()
					document.getElementById('key-input').value = data.key
					document.getElementById('key-id-output').textContent = data.keyId
				} catch (error) {
					console.error('Failed to fetch HMAC key:', error)
					alert('Failed to fetch HMAC key. See console for details.')
				}
			}

			function copySignature() {
				const signature = document.getElementById('signature-output').textContent
				navigator.clipboard.writeText(signature).then(
					function () {
						alert('Signature copied to clipboard!')
					},
					function (err) {
						console.error('Could not copy text: ', err)
					},
				)
			}
		</script>
		<style>
			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				padding: 10px;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			}

			main {
				max-width: 600px;
				margin: 0 auto;
				padding: 20px;
			}

			input, textarea, button {
				width: 100%;
				margin-bottom: 15px;
				padding: 12px;
				border: 1px solid #ddd;
				border-radius: 6px;
				font-size: 16px;
			}

			button {
				background-color: #007AFF;
				color: white;
				border: none;
				cursor: pointer;
				font-weight: 500;
			}

			button:hover {
				background-color: #005ecb;
			}

			button:active {
				background-color: #004494;
			}

			label {
				display: block;
				margin-bottom: 5px;
				font-weight: 500;
				color: #333;
			}

			pre {
				user-select: all;
				background-color: #f5f5f5;
				padding: 10px;
				border-radius: 6px;
				word-wrap: break-word;
				white-space: pre-wrap;
				font-size: 14px;
				margin: 10px 0;
			}

			.form-section {
				margin-bottom: 30px;
			}

			.info-text {
				background-color: #e3f2fd;
				padding: 15px;
				border-radius: 6px;
				margin-bottom: 20px;
				font-size: 14px;
				color: #1565c0;
			}

			@media (max-width: 480px) {
				body {
					padding: 5px;
				}

				main {
					padding: 10px;
				}

				input, textarea, button {
					font-size: 16px;
				}

				textarea {
					min-height: 120px;
				}
			}
		</style>
		<script src="main.js" defer></script>
	</head>
	<body>
		<main>
			<div id="content"></div>
			
			<div class="info-text">
				Script tag local built. Remember to check your PUBLIC_APP_URL on rawTags-refactored.js
			</div>

			<div class="form-section">
				<button onclick="getHmacKey()">Get HMAC Key</button>

				<label for="key-id-output">Key ID:</label>
				<pre id="key-id-output"></pre>

				<label for="key-input">Key (Base64):</label>
				<input type="text" id="key-input" placeholder="HMAC key will appear here..." />

				<label for="payload-input">Payload (JSON):</label>
				<textarea id="payload-input" placeholder='Enter JSON payload here...'></textarea>

				<button onclick="generateSignature()">Generate Signature</button>

				<label for="signature-output">Generated Signature:</label>
				<pre id="signature-output"></pre>

				<button onclick="copySignature()">Copy Signature</button>
			</div>
		</main>
	</body>
</html>
